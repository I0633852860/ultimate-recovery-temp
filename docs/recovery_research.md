# Исследование алгоритмов восстановления exFAT после перезаписи метаданных

## 1. Специфика exFAT при перезаписи
В отличие от NTFS, exFAT использует упрощенную структуру:
- **Volume Boot Record (VBR):** Сектора 0-11.
- **Backup VBR:** Сектора 12-23.
- **FAT Table:** Обычно одна копия (в отличие от FAT32).
- **Upcase Table, Allocation Bitmap:** Критичны для работы ОС, но не для карвинга.

**Проблема dd-перезаписи:** Если образ Chrome OS Flex (~3GB) записан поверх exFAT, он гарантированно уничтожает VBR, Backup VBR и FAT-таблицу.

## 2. Алгоритмы восстановления фрагментированных файлов без FAT
Поскольку FAT-таблица уничтожена, классические методы восстановления цепочек не работают. Необходимы алгоритмы "слепого" карвинга (Blind Carving):

### А. Статистический анализ (Entropy-based)
- **Суть:** Фрагменты одного файла имеют схожую энтропию и распределение байтов.
- **Алгоритм:** Скользящее окно анализирует энтропию Шеннона. Резкое изменение энтропии сигнализирует о границе фрагмента или смене типа данных.

### Б. Бинарное сопоставление (Graph-based Reassembly)
- **Суть:** Представление фрагментов как узлов графа. Ребра — вероятность того, что фрагмент B следует за фрагментом A.
- **Метрики веса ребер:**
    - **Semantic Continuity:** Совпадение структур данных (например, незакрытый JSON-объект в конце A и его продолжение в начале B).
    - **Header-Footer Matching:** Если у типа файла есть четкий футер, это ограничивает поиск.
    - **Sequential Bias:** Вероятность того, что фрагменты идут последовательно на диске (даже с пропусками).

### В. Метод "Smart Separation" (наш подход)
- **Векторный анализ:** Использование N-грамм (2-3 байта) для создания "отпечатка" контента.
- **Косинусное сходство:** Сравнение векторов признаков фрагментов.
- **Учет ΔOffset:** Введение штрафа за физическое расстояние.

## 3. Обнаружение "уцелевших" метаданных
Даже если начало диска перезаписано, метаданные могут сохраниться:
- **Directory Entries в глубине диска:** exFAT хранит записи о файлах в кластерах данных. Если папка находилась далеко от начала, её содержимое (имена, размеры, начальные кластеры) может быть восстановлено.
- **Поиск по сигнатуре `0x85`:** Каждая запись в директории exFAT начинается с байта `0x85` (File Directory Entry). Глобальный поиск этого байта с последующей валидацией структуры может вернуть дерево файлов.

## 4. Рекомендации для UltimateRecovery v11.5
1. **Режим "Forensic Deep Scan":** Поиск сигнатур `0x85` по всему диску для восстановления имен и атрибутов.
2. **Интеграция SmartSeparation в Rust:** Использование SIMD для расчета косинусного сходства векторов N-грамм между фрагментами, помеченными как "сироты" (без метаданных).
3. **Обработка "дыр" (Sparse Carving):** Если фрагмент A заканчивается на полуслове, искать фрагмент B, который начинается с подходящего продолжения, в окне ±500МБ.
