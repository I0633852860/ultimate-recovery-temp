# Стратегия восстановления exFAT после деструктивной перезаписи (dd-image)

## 1. Ситуационный анализ
При записи образа Chrome OS Flex поверх exFAT раздела происходят следующие изменения:
- **LBA 0 - ~6,000,000 (0-3GB):** Полная перезапись. Уничтожены: VBR (загрузочный сектор), FAT-таблица, Allocation Bitmap и корневой каталог.
- **LBA > 6,000,000:** Данные физически сохранены, но "осиротели" — нет цепочек кластеров и имен файлов.

## 2. Алгоритм "Ultimate Reconstruction"

### Фаза 1: Глобальный поиск метаданных (Metadata Mining)
Даже если корень стерт, exFAT хранит записи о файлах в кластерах директорий.
- **Метод:** Сканирование диска на сигнатуру `0x85` (File Directory Entry).
- **Валидация:** Каждая запись `0x85` сопровождается записями `0xC0` (Stream Extension) и `0xC1` (FileName).
- **Результат:** Восстановление имен файлов, размеров и **начальных кластеров** для файлов, чьи родительские папки находились вне зоны перезаписи.

### Фаза 2: Bifragment Gap Carving (BGC)
Для фрагментированных файлов, где начало известно из Фазы 1, но файл "обрывается".
- **Алгоритм:**
    1. Берем начало файла (Fragment A).
    2. Ищем потенциальное окончание (Fragment B) по сигнатурам футеров или семантическому сходству.
    3. Применяем **Brute-force Gap Validation**: пробуем соединить A и B, пропуская "зазор" (gap) переменного размера.
    4. Валидация через `FileReconstructor` (например, проверка валидности JSON).

### Фаза 3: SmartSeparation (Векторный анализ)
Если метаданных нет совсем, используем разработанный ранее метод.
- **Feature Extraction:** Создание 256-мерного вектора частот байт для каждого блока.
- **Cosine Similarity:** Поиск блоков с идентичным "отпечатком" контента.
- **Chain Building:** Сборка блоков в цепочки на основе максимального сходства и минимального ΔOffset.

## 3. Практические рекомендации для пользователя
1. **Не монтировать раздел:** Любая запись ОС (даже лог монтирования) может уничтожить уцелевшие данные.
2. **Снять полный дамп (Image):** Работать только с копией через `dd if=/dev/sdX of=disk_dump.img`.
3. **Приоритет поиска:** Сначала искать сигнатуры `0x85`, так как это даст оригинальные имена и структуру.
4. **Использование Rust-акселератора:** Для поиска `0x85` и расчета косинусного сходства на 500ГБ+ образах обязательно использовать SIMD, иначе поиск займет недели.
